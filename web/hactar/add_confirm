#! /usr/bin/env python

import cgi
import sys
from sqlite3 import IntegrityError
sys.path.append('..')
from hactar.core import User
form = cgi.FieldStorage()

user = form.getvalue('user')
uri = form.getvalue('url')
description = form.getvalue('description')

def head():
    print "Content-type: text/html"
    print
    print "<html><head><title>Add Nugget Confirm</title></head>"

def body(form):
    print "<body>"
    print "Successfully added nugget:</br>"
    print form.getvalue('user')+"</br>"
    print form.getvalue('url')+"</br>"
    print form.getvalue('description')+"</br>"
    print "</body>"

def foot():
    print "</html>"

def invalid_user(user):
    print "<body>"
    print 'Failed: user %s does not exist.' % user
    print "</body>"

def invalid_nugget(message):
    print "<body>"
    print 'Failed to add nugget:</br>'
    print message
    print "</body>"

def duplicate_nugget(uri):
    print "<body>"
    print 'Failed: Nugget with uri: %s already exists.' % uri
    print "</body>"

head()
# validate user
try:
    usr = User(user)
except ValueError:
    # display invalid user page
    invalid_user(user)
    foot()
    exit()

try:
    usr.add_nugget(description, uri)
    body(form)
except ValueError as err:
    invalid_nugget(err.message)
except IntegrityError as err:
    duplicate_nugget(uri)

# validate url

# validate description


foot()
